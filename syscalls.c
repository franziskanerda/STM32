//#pragma GCC optimize 0

/** Description        *******************************************************************************/
/** #INCLUDES          *******************************************************************************/
#include <unistd.h>
#include <sys/stat.h>
#include "system.h"
#include "syslib.h"


/** #DEFINES           *******************************************************************************/
/** ENUMS              *******************************************************************************/
/** STRUCTS            *******************************************************************************/
/** CONSTS             *******************************************************************************/
/** Public Variables   *******************************************************************************/
/** Public Functions   *******************************************************************************/
/** Private Variables  *******************************************************************************/
/** Private Functions  *******************************************************************************/

/** Code               *******************************************************************************/

/******************************************************************************************************
                                                 _sbrk
-------------------------------------------------------------------------------------------------------
******************************************************************************************************/
caddr_t _sbrk( int incr ) {
   register char *stack_ptr asm ("sp");
   extern char   end;  // Defined by the linker
   static char   *heap_end;
   char *prev_heap_end;

   if ( heap_end == 0 ) {
      heap_end = &end;
   }
   prev_heap_end = heap_end;
   if ( heap_end + incr > stack_ptr ) {
      //stack and heap collision detected!!!
      ErrorBlink( ERR_BLINK_HEAPOVERFLOW, FALSE );
   }

   heap_end += incr;
   return (caddr_t)prev_heap_end;
}

/******************************************************************************************************
                                                 abort
-------------------------------------------------------------------------------------------------------
******************************************************************************************************/
void abort( void ) {
   ErrorBlink( ERR_BLINK_SYSEXIT, FALSE );
   for ( ;  ; ) ;
}

/******************************************************************************************************
                                             __io_putchar
-------------------------------------------------------------------------------------------------------
******************************************************************************************************/
void __io_putchar( char c ) {
   // \n is not enough. Need \r too!
   if( c == 0x0A ) {
      __io_putchar( 0x0D );
   }

   while( USART_GetFlagStatus( USART1, USART_FLAG_TXE ) == RESET ) {}
   USART_SendData( USART1, (u8)c );
}

/******************************************************************************************************
                                                putchar
-------------------------------------------------------------------------------------------------------
******************************************************************************************************/
int putchar( int c ) {
   __io_putchar( (char)c );
   return c;
}

/******************************************************************************************************
                                             __io_getchar
-------------------------------------------------------------------------------------------------------
******************************************************************************************************/
int __io_getchar() {
   unsigned short value;

   while( USART_GetFlagStatus( USART1, USART_FLAG_RXNE ) == RESET ) {}
   value = USART_ReceiveData( USART1 );

   return (int)(value);
}

/******************************************************************************************************
                                                getchar
-------------------------------------------------------------------------------------------------------
******************************************************************************************************/
int getchar() {
   return __io_getchar();
}

/******************************************************************************************************
                                                _write
-------------------------------------------------------------------------------------------------------
******************************************************************************************************/
int _write( int file, char *ptr, int len ) {
   int todo;

   for ( todo = 0; todo < len; todo++ ) {
      __io_putchar( *ptr++ );
   }

   return len;
   file = file;
}

/******************************************************************************************************
                                                _close
-------------------------------------------------------------------------------------------------------
******************************************************************************************************/
int _close( int file ) {
   return -1;
   file = file;
}

/******************************************************************************************************
                                                _fstat
-------------------------------------------------------------------------------------------------------
******************************************************************************************************/
int _fstat( int file, struct stat *st ) {
   st->st_mode = S_IFCHR;
   return 0;
   file = file;
}

/******************************************************************************************************
                                                _isatty
-------------------------------------------------------------------------------------------------------
******************************************************************************************************/
int _isatty( int fd ) {
   return 1;
   fd = fd;
}

/******************************************************************************************************
                                                _lseek
-------------------------------------------------------------------------------------------------------
******************************************************************************************************/
int _lseek( int file, int ptr, int dir ) {
   return 0;
   file = file;
   ptr = ptr;
   dir = dir;
}

/******************************************************************************************************
                                                 _read
-------------------------------------------------------------------------------------------------------
******************************************************************************************************/
int _read( int file, char *ptr, int len ) {
   return 0;
   file = file;
   ptr = ptr;
   len = len;
}

//#pragma GCC reset_options